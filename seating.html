<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº§ä½æŠ½ç±¤ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-bg: #fdfbf7;
            --container-bg: #ffffff;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --accent-color: #6c5ce7;
            
            /* åº§ä½é¡è‰² */
            --boy-bg: linear-gradient(135deg, #74b9ff, #0984e3);
            --girl-bg: linear-gradient(135deg, #ff7675, #d63031);
            --empty-bg: #f1f2f6;
            --empty-border: #dfe6e9;
            
            /* ç‹€æ…‹é¡è‰² */
            --select-border: #fdcb6e;
            --locked-border: #2d3436;
        }

        body {
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-main);
            padding: 40px 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 950px;
            background: var(--container-bg);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        /* æ¨™é¡Œå€ */
        header { text-align: center; margin-bottom: 30px; }
        h2 { margin: 0; font-size: 28px; color: var(--text-main); letter-spacing: 1px; margin-bottom: 10px; }
        
        .subtitle { 
            color: var(--text-sub); 
            font-size: 15px; 
            background: #f1f2f6;
            display: inline-block;
            padding: 8px 20px;
            border-radius: 50px;
        }

        /* è¨­å®šå€å¡Š */
        .settings-grid {
            display: grid;
            grid-template-columns: 200px 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: #fafafa;
            border-radius: 16px;
            border: 1px solid #eee;
        }
        
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 15px; font-weight: 700; color: var(--text-main); margin-bottom: 10px; }
        
        input, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
            resize: none;
            color: #333;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
        }
        textarea { height: 100px; }
        
        /* åº§ä½å¤§å°è¼¸å…¥æ¡† */
        .size-inputs { display: flex; align-items: center; gap: 10px; }
        .size-box { flex: 1; display: flex; flex-direction: column; }
        
        /* è¼¸å…¥æ•¸å­—ç½®ä¸­ */
        .size-box input {
            text-align: center; 
            width: 100%; 
            box-sizing: border-box;
            font-size: 18px; 
            font-weight: bold; 
            color: var(--accent-color);
        }
        
        .size-label { font-size: 12px; color: #888; margin-bottom: 4px; text-align: center; }
        .separator { font-weight: bold; color: #b2bec3; font-size: 18px; margin-top: 15px; }

        /* æŒ‰éˆ•å€ */
        .actions { 
            display: flex; justify-content: center; gap: 15px; 
            margin-bottom: 30px; flex-wrap: wrap;
        }

        button {
            padding: 12px 28px; font-size: 16px; font-weight: 600;
            border: none; border-radius: 50px; cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            display: flex; align-items: center; gap: 8px;
            color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
        button:active { transform: translateY(0); }

        .btn-mix { background: linear-gradient(135deg, #636e72, #2d3436); }
        .btn-alt { background: linear-gradient(135deg, #00b894, #00cec9); }
        .btn-print { background: linear-gradient(135deg, #0984e3, #74b9ff); }
        .btn-excel { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .btn-clear { background: linear-gradient(135deg, #d63031, #e17055); }

        .platform {
            width: 200px; height: 45px; background: #dfe6e9; color: #636e72;
            margin: 0 auto 25px auto; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; letter-spacing: 4px; font-weight: bold; font-size: 16px; display: none;
        }

        .status-bar { 
            text-align: center; color: var(--text-sub); font-size: 15px; 
            margin-bottom: 20px; min-height: 24px; font-weight: 500;
        }

        /* åº§ä½åœ°åœ– */
        #seat-map { display: grid; gap: 12px; justify-content: center; padding: 10px; }

        .seat {
            width: 95px; height: 70px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 12px;
            font-weight: bold; font-size: 18px;
            color: white;
            position: relative;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: background 0.2s; 
            overflow: visible;
        }
        
        .seat.boy { background: var(--boy-bg); }
        .seat.girl { background: var(--girl-bg); }
        .seat.empty { 
            background: var(--empty-bg); color: #b2bec3; 
            border: 2px dashed var(--empty-border); box-shadow: none; font-size: 14px;
        }

        /* é¸å–ç‹€æ…‹ï¼šåªåŠ å¤–æ¡†å…‰æšˆï¼Œä¸è®Šå¤§ */
        .seat.selected {
            box-shadow: 0 0 0 4px var(--select-border); 
            z-index: 10;
        }

        /* é–å®šç‹€æ…‹ï¼šåŠ æ·±è‰²æ¡†ï¼Œæ¸¸æ¨™è®Šç¦æ­¢ */
        .seat.locked { 
            box-shadow: 0 0 0 3px var(--locked-border);
            cursor: not-allowed;
            opacity: 0.95;
        }

        /* äº’å‹•å¼é–å®šæŒ‰éˆ• (æµ®å‹•åœ¨å³ä¸Šè§’) */
        .toggle-lock-btn {
            display: none; 
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 50%;
            font-size: 12px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 20;
            color: #333;
        }

        .seat.selected .toggle-lock-btn,
        .seat.locked .toggle-lock-btn {
            display: flex;
        }

        .seat.locked .toggle-lock-btn {
            background: #fff;
            border-color: var(--locked-border);
        }

        @media (max-width: 768px) {
            .settings-grid { grid-template-columns: 1fr; }
            .container { padding: 20px; }
            .seat { width: 70px; height: 50px; font-size: 16px; }
        }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ (PDF/é»‘ç™½) --- */
        @media print {
            body { background: white; padding: 0; margin: 0; }
            .container { box-shadow: none; max-width: 100%; border: none; padding: 0; }
            
            /* éš±è—æ“ä½œä»‹é¢ */
            header, .settings-grid, .actions, .status-bar, .toggle-lock-btn { display: none !important; }
            
            /* æ¸…é™¤é–å®šè¦–è¦º */
            .seat.locked { box-shadow: none !important; opacity: 1 !important; }

            #seat-map { margin-top: 20px; }
            
            /* å¼·åˆ¶é»‘ç™½æ¨£å¼ï¼Œå»èƒŒ */
            .seat { 
                border: 1px solid #000 !important; 
                color: black !important; 
                box-shadow: none !important; 
                background: white !important; 
                filter: none !important;
                -webkit-print-color-adjust: exact;
            }
            .seat.boy, .seat.girl { background: white !important; }
            
            /* ä¿®æ­£ï¼šç©ºç™½åº§ä½åœ¨åˆ—å°æ™‚éš±è— (visibility: hidden) */
            /* é€™æ¨£å¯ä»¥ä¿ç•™ä½”ä½ï¼Œä½†çœ‹ä¸åˆ°æ¡†æ¡† */
            .seat.empty { 
                visibility: hidden !important;
                border: none !important;
            }
            
            .platform { display: flex !important; background: #fff !important; color: #000 !important; border: 2px solid #000; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>ğŸ“ åº§ä½æŠ½ç±¤ç³»çµ±</h2>
        <div class="subtitle">è¼¸å…¥åå–® &rarr; é¸æ“‡æ¨¡å¼ &rarr; é–å®šåº§ä½ &rarr; åŒ¯å‡º</div>
    </header>
    
    <div class="settings-grid">
        <div class="input-group">
            <label>1. åº§ä½å¤§å°</label>
            <div class="size-inputs">
                <div class="size-box">
                    <span class="size-label">ç›´æ’ (Rows)</span>
                    <input type="number" id="rows" value="5" min="1" onchange="saveData()">
                </div>
                <span class="separator">X</span>
                <div class="size-box">
                    <span class="size-label">æ©«åˆ— (Cols)</span>
                    <input type="number" id="cols" value="6" min="1" onchange="saveData()">
                </div>
            </div>
        </div>

        <div class="input-group">
            <label>2. å¥³ç”Ÿåå–®</label>
            <textarea id="girls-list" placeholder="è«‹è²¼ä¸Šåå­—æˆ–åº§è™Ÿ..." oninput="saveData()"></textarea>
        </div>

        <div class="input-group">
            <label>3. ç”·ç”Ÿåå–®</label>
            <textarea id="boys-list" placeholder="è«‹è²¼ä¸Šåå­—æˆ–åº§è™Ÿ..." oninput="saveData()"></textarea>
        </div>
    </div>

    <div class="actions">
        <button class="btn-mix" onclick="generateSeats('mixed')">ğŸ² éš¨æ©Ÿæ··åˆ</button>
        <button class="btn-alt" onclick="generateSeats('alternate')">â™Ÿï¸ æ¢…èŠ±åº§</button>
        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
        <button class="btn-excel" onclick="exportToExcel()">ğŸ“Š ä¸‹è¼‰ Excel</button>
        <button class="btn-clear" onclick="resetSystem()">ğŸ—‘ï¸ å…¨éƒ¨æ¸…é™¤</button>
    </div>

    <div class="platform" id="platform">è¬› å°</div>
    <div class="status-bar" id="status-msg"></div>
    <div id="seat-map"></div>
</div>

<script>
    let currentSeatsState = [];
    let selectedIndex = null;

    window.onload = function() {
        loadData();
    };

    function saveData() {
        localStorage.setItem('seat_rows', document.getElementById('rows').value);
        localStorage.setItem('seat_cols', document.getElementById('cols').value);
        localStorage.setItem('seat_boys', document.getElementById('boys-list').value);
        localStorage.setItem('seat_girls', document.getElementById('girls-list').value);
        if(currentSeatsState.length > 0) {
            localStorage.setItem('seat_state', JSON.stringify(currentSeatsState));
        }
    }

    function loadData() {
        document.getElementById('rows').value = localStorage.getItem('seat_rows') || 5;
        document.getElementById('cols').value = localStorage.getItem('seat_cols') || 6;
        document.getElementById('boys-list').value = localStorage.getItem('seat_boys') || "";
        document.getElementById('girls-list').value = localStorage.getItem('seat_girls') || "";
        
        if(localStorage.getItem('seat_state')) {
            currentSeatsState = JSON.parse(localStorage.getItem('seat_state'));
            const rows = parseInt(document.getElementById('rows').value);
            const cols = parseInt(document.getElementById('cols').value);
            renderSeats(rows, cols);
        }
    }

    // å…¨éƒ¨æ¸…é™¤åŠŸèƒ½
    function resetSystem() {
        if(!confirm("âš ï¸ ç¢ºå®šè¦å…¨éƒ¨æ¸…é™¤å—ï¼Ÿ\n\né€™å°‡æœƒåˆªé™¤æ‰€æœ‰è¼¸å…¥çš„åå–®å’Œç›®å‰çš„åº§ä½è¡¨ã€‚")) {
            return;
        }
        
        // æ¸…é™¤è³‡æ–™
        document.getElementById('boys-list').value = "";
        document.getElementById('girls-list').value = "";
        document.getElementById('rows').value = 5;
        document.getElementById('cols').value = 6;
        currentSeatsState = [];
        selectedIndex = null;

        // æ¸…é™¤ Storage
        localStorage.clear();

        // é‡æ–°æ¸²æŸ“
        document.getElementById('seat-map').innerHTML = "";
        document.getElementById('status-msg').innerHTML = "";
        document.getElementById('platform').style.display = 'none';
    }

    function parseList(text) {
        if(!text) return [];
        return text.split(/[\n,]+/).map(s => s.trim()).filter(s => s !== "");
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function generateSeats(mode) {
        const rows = parseInt(document.getElementById('rows').value);
        const cols = parseInt(document.getElementById('cols').value);
        const totalSeats = rows * cols;

        let boysInput = document.getElementById('boys-list').value;
        let girlsInput = document.getElementById('girls-list').value;

        if(!boysInput && !girlsInput) {
            alert("è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥åå–®å–”ï¼");
            return;
        }

        let boysSource = parseList(boysInput).map(name => ({name, gender: 'boy', locked: false}));
        let girlsSource = parseList(girlsInput).map(name => ({name, gender: 'girl', locked: false}));
        
        let lockedNames = new Set();
        let finalOrder = new Array(totalSeats).fill(null);

        if (currentSeatsState.length === totalSeats) {
            currentSeatsState.forEach((seat, index) => {
                if (seat && seat.locked && seat.gender !== 'empty') {
                    finalOrder[index] = seat;
                    lockedNames.add(seat.name);
                }
            });
        }

        let boysToShuffle = boysSource.filter(b => !lockedNames.has(b.name));
        let girlsToShuffle = girlsSource.filter(g => !lockedNames.has(g.name));
        
        shuffle(boysToShuffle);
        shuffle(girlsToShuffle);

        if (mode === 'mixed') {
            let allRemaining = boysToShuffle.concat(girlsToShuffle);
            shuffle(allRemaining);
            
            for(let i=0; i<totalSeats; i++) {
                if (finalOrder[i] === null) {
                    if (allRemaining.length > 0) finalOrder[i] = allRemaining.shift();
                    else finalOrder[i] = {name: "ç©º", gender: "empty", locked: false};
                }
            }
        } else {
            let groupA_Indices = [];
            let groupB_Indices = [];
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    let index = r * cols + c;
                    if (finalOrder[index] === null) {
                        if ((r + c) % 2 === 0) groupA_Indices.push(index);
                        else groupB_Indices.push(index);
                    }
                }
            }
            let boyGroup, girlGroup;
            if (Math.random() > 0.5) { boyGroup = groupA_Indices; girlGroup = groupB_Indices; } 
            else { boyGroup = groupB_Indices; girlGroup = groupA_Indices; }

            while (boysToShuffle.length > 0 && boyGroup.length > 0) finalOrder[boyGroup.shift()] = boysToShuffle.shift();
            while (girlsToShuffle.length > 0 && girlGroup.length > 0) finalOrder[girlGroup.shift()] = girlsToShuffle.shift();
            
            let remainingSlots = boyGroup.concat(girlGroup);
            let remainingStudents = boysToShuffle.concat(girlsToShuffle);
            while(remainingStudents.length > 0 && remainingSlots.length > 0) finalOrder[remainingSlots.shift()] = remainingStudents.shift();

            for(let i=0; i<totalSeats; i++) {
                if (!finalOrder[i]) finalOrder[i] = {name: "ç©º", gender: "empty", locked: false};
            }
        }

        currentSeatsState = finalOrder;
        saveData();
        renderSeats(rows, cols);
    }

    function renderSeats(rows, cols) {
        const container = document.getElementById('seat-map');
        const statusMsg = document.getElementById('status-msg');
        const platform = document.getElementById('platform');
        
        container.innerHTML = '';
        container.style.gridTemplateColumns = `repeat(${cols}, 95px)`;
        platform.style.display = 'flex';

        const totalStudents = currentSeatsState.filter(s => s.gender !== 'empty').length;
        statusMsg.innerHTML = `ç¸½äººæ•¸: ${totalStudents} äºº &nbsp;|&nbsp; é»æ“Šé¸å–å¯äº¤æ›ï¼Œé»æ“Šå³ä¸Šè§’é–é ­å¯å›ºå®š`;

        currentSeatsState.forEach((student, index) => {
            const seatDiv = document.createElement('div');
            seatDiv.className = 'seat';
            seatDiv.classList.add(student.gender);
            if(student.locked) seatDiv.classList.add('locked');
            
            if (selectedIndex === index) {
                seatDiv.classList.add('selected');
            }

            seatDiv.innerText = student.name;
            seatDiv.id = `seat-${index}`;
            seatDiv.onclick = (e) => handleSeatClick(index, e);

            if (student.gender !== 'empty') {
                const lockBtn = document.createElement('div');
                lockBtn.className = 'toggle-lock-btn';
                lockBtn.innerHTML = student.locked ? 'ğŸ”’' : 'ğŸ”“';
                lockBtn.title = student.locked ? 'è§£é–' : 'é–å®š';
                lockBtn.onclick = (e) => toggleLock(index, e);
                seatDiv.appendChild(lockBtn);
            }

            container.appendChild(seatDiv);
        });
    }

    function toggleLock(index, event) {
        event.stopPropagation();
        
        currentSeatsState[index].locked = !currentSeatsState[index].locked;
        
        if(currentSeatsState[index].locked && selectedIndex === index) {
            selectedIndex = null;
        }

        saveData();
        const rows = parseInt(document.getElementById('rows').value);
        const cols = parseInt(document.getElementById('cols').value);
        renderSeats(rows, cols);
    }

    function handleSeatClick(index, event) {
        if (currentSeatsState[index].locked) return;

        const rows = parseInt(document.getElementById('rows').value);
        const cols = parseInt(document.getElementById('cols').value);

        if (selectedIndex === null) {
            selectedIndex = index;
            renderSeats(rows, cols); 
        } else if (selectedIndex === index) {
            selectedIndex = null;
            renderSeats(rows, cols);
        } else {
            if (currentSeatsState[index].locked) return;

            const temp = currentSeatsState[selectedIndex];
            currentSeatsState[selectedIndex] = currentSeatsState[index];
            currentSeatsState[index] = temp;
            
            selectedIndex = null;
            saveData();
            renderSeats(rows, cols);
        }
    }

    function exportToExcel() {
        if (currentSeatsState.length === 0) { alert("è«‹å…ˆç”¢ç”Ÿåº§ä½è¡¨ï¼"); return; }
        const rows = parseInt(document.getElementById('rows').value);
        const cols = parseInt(document.getElementById('cols').value);
        let data = [];
        data.push(["è¬›å°ä½ç½®"]); data.push([]); 
        for (let r = 0; r < rows; r++) {
            let rowData = [];
            for (let c = 0; c < cols; c++) {
                let index = r * cols + c;
                let student = currentSeatsState[index];
                let cellText = student.name === "ç©º" ? "" : student.name;
                rowData.push(cellText);
            }
            data.push(rowData);
        }
        let wb = XLSX.utils.book_new();
        let ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, "åº§ä½è¡¨");
        XLSX.writeFile(wb, `ç­ç´šåº§ä½è¡¨_${new Date().toLocaleDateString()}.xlsx`);
    }
</script>

</body>
</html>